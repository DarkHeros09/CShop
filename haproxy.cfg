global
    # Define the number of threads to use (set to your number of CPU cores)
    nbthread 2 
    # Pin threads to specific CPU cores for better performance
    #cpu-map 0/1 1/2

    # Default SSL/TLS settings for security and performance
    tune.ssl.default-dh-param 2048
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

    # Logging
    log /dev/log    local0
    log /dev/log    local1 notice

    # Other global settings
    # chroot /var/lib/haproxy
    # stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    # user haproxy
    # group haproxy
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    # Critical performance setting: enables keep-alive connections to the backend
    option  http-server-close 
    # Automatically add X-Forwarded-For, X-Forwarded-Proto, etc.
    option  forwardfor
    
    # Timeouts for stability
    timeout connect 5s
    timeout client  50s
    timeout server  50s

frontend https_frontend
    # Bind to port 443 for SSL/TLS traffic
    # Note: Create domain.pem by combining your .crt and .key:
    # cat nginx.crt nginx.key > /usr/local/etc/haproxy/certs/domain.pem
    bind *:443 ssl crt /usr/local/etc/haproxy/certs/domain.pem alpn h2,http/1.1 ca-file /usr/local/etc/haproxy/certs/flutter.crt verify required

    # Client Certificate (mTLS) Verification
    # This translates nginx's ssl_verify_client and ssl_client_certificate
    # bind *:443 ssl 

    # Set headers similar to nginx's proxy_set_header
    http-request set-header X-Real-IP %[src]

    http-request add-header X-Forwarded-For %[src]

    # Direct all traffic to our Go server backend
    default_backend go_server_backend

backend go_server_backend
    # Use 'leastconn' for better load distribution if you add more servers
    balance roundrobin
    
    # Define the backend server
    # The 'check' parameter enables active health checks for reliability
    server go_server1 go-server:8080 check